#include "ysJob.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void ysJob::Reset()
{
    m_workerMgr = nullptr;
    m_fcn = nullptr;
    m_fcnArg = nullptr;
    m_parent = nullptr;
    m_unfinishedJobCount.store(0, std::memory_order_release);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void ysJob::Create(const ysJobDef& def)
{
    ysAssert(def.m_workerMgr != nullptr);
    ysAssert(def.m_fcn != nullptr);
    m_workerMgr = def.m_workerMgr;
    m_fcn = def.m_fcn;
    m_fcnArg = def.m_fcnArg;
    m_parent = def.m_parentJob;
    m_unfinishedJobCount.store(1, std::memory_order_release);
    if (m_parent != nullptr)
    {
        m_parent->m_unfinishedJobCount.fetch_add(1, std::memory_order_release);
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void ysJob::Execute()
{
    m_fcn(*this, m_fcnArg);
    __Finish();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
bool ysJob::IsFinished() const
{
    ys_int32 count = m_unfinishedJobCount.load(std::memory_order_acquire);
    return (count == 0);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void ysJob::__Finish()
{
    ys_int32 count = m_unfinishedJobCount.fetch_sub(1, std::memory_order_acq_rel);
    ysAssert(count >= 1);
    if (count == 1 && m_parent != nullptr)
    {
        m_parent->__Finish();
    }
}